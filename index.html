<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AS/NZS 3000 Conduit Visualiser</title>
    <style>
        :root {
            --primary: #2563eb; --danger: #dc2626; --success: #16a34a;
            --bg: #f1f5f9; --card-bg: #ffffff; --text: #1e293b; --border: #cbd5e1;
        }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; max-width: 1300px; width: 100%; }
        .controls { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); flex: 1; min-width: 380px; max-width: 500px; }
        .category-group { background: #f8fafc; padding: 12px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 15px; }
        h3 { margin-top: 0; font-size: 1rem; color: var(--primary); border-bottom: 1px solid var(--border); padding-bottom: 5px; }
        label { display: block; margin: 10px 0 5px; font-weight: 700; font-size: 0.8rem; }
        select, input { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; box-sizing: border-box; }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
        .btn { padding: 10px; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; font-size: 0.8rem; transition: 0.2s; }
        .btn-add { background: var(--primary); color: white; }
        .btn-fill { background: #0f172a; color: white; }
        .btn-reset { background: #64748b; color: white; width: 100%; margin-top: 15px; }
        .stats-panel { border-top: 2px solid var(--border); margin-top: 20px; padding-top: 15px; }
        .stat-row { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; }
        .fill-bar-bg { height: 24px; background: #e2e8f0; border-radius: 12px; overflow: hidden; position: relative; margin: 10px 0; border: 1px solid #94a3b8; }
        .fill-bar-inner { height: 100%; width: 0%; transition: 0.4s ease-out; }
        .limit-line { position: absolute; top: 0; bottom: 0; width: 3px; background: #000; z-index: 5; }
        .inventory { margin-top: 15px; max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 6px; background: white; }
        .inv-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; border-bottom: 1px solid #f1f5f9; font-size: 0.75rem; }
        .btn-remove { background: #fee2e2; color: var(--danger); border: 1px solid #fecaca; padding: 2px 6px; border-radius: 3px; cursor: pointer; }
        .canvas-area { background: var(--card-bg); padding: 30px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); text-align: center; position: sticky; top: 20px; height: fit-content; }
        .conduit-label { font-size: 1.2rem; font-weight: 800; color: #1e293b; margin-bottom: 15px; padding: 8px; background: #f8fafc; border-radius: 6px; border: 1px dashed var(--border); }
        .warning-msg { color: var(--danger); background: #fef2f2; padding: 10px; border-radius: 6px; font-size: 0.85rem; margin-top: 10px; display: none; font-weight: bold; border: 1px solid #fee2e2; }
    </style>
</head>
<body>

    <h1 style="margin-bottom:25px;">AS/NZS 3000 Conduit Visualiser</h1>

    <div class="container">
        <div class="controls">
            <div class="category-group" style="background: #fff;">
                <label>Conduit Size (Outer Diameter)</label>
                <div style="display:flex; gap:10px;">
                    <input type="number" id="conSize" value="63">
                    <button class="btn btn-add" style="width:100px" onclick="updateConduitSize()">Set</button>
                </div>
                <p style="font-size: 0.7rem; color: #64748b; margin-top: 5px;">*Internal usable space accounts for ~3.2mm wall thickness.</p>
            </div>

            <div class="category-group">
                <h3>Power</h3>
                <select id="pwrSel">
                    <optgroup label="TriCab XL (Alu Flexible Rubber)">
                        <option value="6.8">1.5mm² XL Series (6.8mm OD)</option>
                        <option value="7.6">2.5mm² XL Series (7.6mm OD)</option>
                        <option value="8.9">4.0mm² XL Series (8.9mm OD)</option>
                        <option value="10.2">6.0mm² XL Series (10.2mm OD)</option>
                        <option value="12.1">10mm² XL Series (12.1mm OD)</option>
                        <option value="20.8">16mm² XL Series (20.8mm OD)</option>
                        <option value="23.2">25mm² XL Series (23.2mm OD)</option>
                        <option value="26.1">35mm² XL Series (26.1mm OD)</option>
                        <option value="28.9">50mm² XL Series (28.9mm OD)</option>
                        <option value="33.5">70mm² XL Series (33.5mm OD)</option>
                        <option value="37.8">95mm² XL Series (37.8mm OD)</option>
                    </optgroup>
                    <optgroup label="TPS (2C + E)">
                        <option value="9.9">1.5mm² Flat (9.9mm OD)</option>
                        <option value="11.2">2.5mm² Flat (11.2mm OD)</option>
                        <option value="12.8">4.0mm² Flat (12.8mm OD)</option>
                        <option value="14.5">6.0mm² Flat (14.5mm OD)</option>
                        <option value="18.1">10mm² Flat (18.1mm OD)</option>
                        <option value="22.3">16mm² Flat (22.3mm OD)</option>
                        <option value="27.8">25mm² Flat (27.8mm OD)</option>
                    </optgroup>
                    <optgroup label="Orange Circular (2C + E)">
                        <option value="10.5">1.5mm² Circ (10.5mm OD)</option>
                        <option value="11.6">2.5mm² Circ (11.6mm OD)</option>
                        <option value="13.2">4.0mm² Circ (13.2mm OD)</option>
                        <option value="14.8">6.0mm² Circ (14.8mm OD)</option>
                        <option value="18.5">10mm² Circ (18.5mm OD)</option>
                        <option value="21.3">16mm² Circ (21.3mm OD)</option>
                        <option value="25.2">25mm² Circ (25.2mm OD)</option>
                    </optgroup>
                </select>
                <div class="btn-grid">
                    <button class="btn btn-add" onclick="handleAdd('pwrSel', 'power')">Add One</button>
                    <button class="btn btn-fill" onclick="handleBulk('pwrSel', 'power')">Fill to Max</button>
                </div>
            </div>

            <div class="category-group">
                <h3>Fibre</h3>
                <select id="fbrSel">
                    <optgroup label="MILSPEC">
                        <option value="5.5">2-Core MILSPEC (5.5mm OD)</option>
                        <option value="6.5">4-Core MILSPEC (6.5mm OD)</option>
                    </optgroup>
                    <optgroup label="Single Mode">
                        <option value="9.5">12-Core SM (9.5mm OD)</option>
                        <option value="12.5">24-Core SM (12.5mm OD)</option>
                        <option value="15.5">48-Core SM (15.5mm OD)</option>
                        <option value="18.0">72-Core SM (18.0mm OD)</option>
                        <option value="22.5">144-Core SM (22.5mm OD)</option>
                        <option value="24.8">216-Core SM (24.8mm OD)</option>
                    </optgroup>
                </select>
                <div class="btn-grid">
                    <button class="btn btn-add" style="background:#0284c7" onclick="handleAdd('fbrSel', 'fibre')">Add One</button>
                    <button class="btn btn-fill" onclick="handleBulk('fbrSel', 'fibre')">Fill to Max</button>
                </div>
            </div>

            <div class="category-group">
                <h3>Traffic Signals</h3>
                <select id="trfSel">
                    <option value="8.1">Loop Feeder (8.1mm OD)</option>
                    <option value="11.5">6-Core Traffic (11.5mm OD)</option>
                    <option value="19.2">19-Core Traffic (19.2mm OD)</option>
                    <option value="24.5">29-Core Traffic (24.5mm OD)</option>
                    <option value="27.8">36-Core Traffic (27.8mm OD)</option>
                    <option value="32.0">51-Core Traffic (32.0mm OD)</option>
                </select>
                <div class="btn-grid">
                    <button class="btn btn-add" style="background:#ea580c" onclick="handleAdd('trfSel', 'traffic')">Add One</button>
                    <button class="btn btn-fill" onclick="handleBulk('trfSel', 'traffic')">Fill to Max</button>
                </div>
            </div>

            <div class="stats-panel">
                <div class="stat-row">
                    <span>Cable Count: <span id="cableCount">0</span></span>
                    <span>Fill: <span id="fillPct">0%</span></span>
                </div>
                <div class="stat-row" style="color:#64748b; font-size:0.8rem;">
                    <span>Current Max Allowed:</span>
                    <span><span id="maxAllowed">50%</span></span>
                </div>
                <div class="fill-bar-bg">
                    <div id="barLimit" class="limit-line" style="left: 50%;"></div>
                    <div id="barInner" class="fill-bar-inner"></div>
                </div>
                <div id="warn" class="warning-msg"></div>
                <label>Inventory Log</label>
                <div class="inventory" id="invList"></div>
                <button class="btn btn-reset" onclick="reset()">Reset All Data</button>
            </div>
        </div>

        <div class="canvas-area">
            <div class="conduit-label" id="currentConduitDisplay">63mm Conduit</div>
            <canvas id="c" width="500" height="500"></canvas>
            <div style="margin-top:15px; font-size:0.85rem; display:flex; gap:20px; justify-content:center; font-weight:600;">
                <span><span style="color:#ef4444">■</span> Power</span>
                <span><span style="color:#0284c7">■</span> Fibre</span>
                <span><span style="color:#ea580c">■</span> Traffic</span>
            </div>
        </div>
    </div>

    <script>
        let conduitD = 63;
        let wallThickness = 3.2; 
        let usableRadius = (conduitD - (wallThickness * 2)) / 2;
        let cables = [];
        const canvas = document.getElementById('c'), ctx = canvas.getContext('2d');
        const colors = { power: '#ef4444', fibre: '#0284c7', traffic: '#ea580c' };

        function handleAdd(id, type) {
            const sel = document.getElementById(id);
            const d = parseFloat(sel.value), label = sel.options[sel.selectedIndex].text;
            if (addCableLogic(d, type, label)) update();
        }

        function handleBulk(id, type) {
            const sel = document.getElementById(id);
            const d = parseFloat(sel.value), label = sel.options[sel.selectedIndex].text;
            let addedCount = 0;
            while (addedCount < 200) {
                const tempArea = cables.reduce((acc, c) => acc + Math.PI * c.r**2, 0) + (Math.PI * (d/2)**2);
                const totalInternalArea = Math.PI * usableRadius**2;
                const nextFill = (tempArea / totalInternalArea) * 100;
                
                const limit = (cables.length + 1) >= 2 ? (cables.length + 1 === 2 ? 33 : 40) : 50;
                if (nextFill > limit) break;
                if (!addCableLogic(d, type, label)) break;
                addedCount++;
            }
            update();
        }

        function addCableLogic(d, type, label) {
            const r = d / 2;
            if (d > usableRadius * 2) { alert("Cable too large for the internal diameter of this conduit!"); return false; }
            
            const pos = findPos(r);
            if (pos) {
                cables.push({ id: Math.random(), x: pos.x, y: pos.y, r, d, type, label });
                return true;
            }
            document.getElementById('warn').style.display = 'block';
            document.getElementById('warn').textContent = "Physical Geometry Exhausted: Cannot fit another cable.";
            return false;
        }

        function removeCable(id) { cables = cables.filter(c => c.id !== id); repack(); update(); }

        function repack() {
            const old = [...cables]; cables = [];
            old.sort((a,b) => b.r - a.r); 
            old.forEach(c => { const p = findPos(c.r); if(p) { c.x = p.x; c.y = p.y; cables.push(c); }});
        }

        // NEW NESTING ALGORITHM: Searches bottom-up (Gravity style)
        function findPos(r) {
            const step = 0.5;
            for (let y = usableRadius - r; y > -usableRadius + r; y -= step) {
                for (let x = -usableRadius + r; x < usableRadius - r; x += step) {
                    if (isValid(x, y, r)) return {x, y};
                }
            }
            return null;
        }

        function isValid(x, y, r) {
            if (Math.sqrt(x*x + y*y) + r > usableRadius) return false;
            return !cables.some(c => Math.sqrt((x-c.x)**2 + (y-c.y)**2) < (r + c.r) - 0.05);
        }

        function update() {
            const count = cables.length;
            const cArea = cables.reduce((acc, c) => acc + Math.PI * c.r**2, 0);
            const totalInternalArea = Math.PI * usableRadius**2;
            const pct = (cArea / totalInternalArea) * 100;
            const limit = count === 0 ? 50 : (count === 1 ? 50 : (count === 2 ? 33 : 40));
            
            document.getElementById('currentConduitDisplay').textContent = conduitD + 'mm Conduit';
            document.getElementById('cableCount').textContent = count;
            document.getElementById('fillPct').textContent = pct.toFixed(1) + '%';
            document.getElementById('maxAllowed').textContent = limit + '%';
            document.getElementById('barLimit').style.left = limit + '%';
            
            const bar = document.getElementById('barInner');
            bar.style.width = Math.min(pct, 100) + '%';
            bar.style.background = pct > limit ? 'var(--danger)' : 'var(--success)';
            
            const warn = document.getElementById('warn');
            if(pct > limit) {
                warn.style.display = 'block';
                warn.textContent = `AS/NZS 3000 VIOLATION: ${pct.toFixed(1)}% exceeds ${limit}% limit.`;
            } else {
                warn.style.display = 'none';
            }

            document.getElementById('invList').innerHTML = cables.map(c => `
                <div class="inv-item">
                    <span>${c.label}</span>
                    <button class="btn-remove" onclick="removeCable(${c.id})">✕</button>
                </div>
            `).reverse().join('');
            draw();
        }

        function draw() {
            ctx.clearRect(0,0,500,500);
            const scale = 440 / conduitD;
            
            ctx.beginPath();
            ctx.arc(250, 250, (conduitD/2)*scale, 0, 7);
            ctx.fillStyle = '#94a3b8'; ctx.fill(); 

            ctx.beginPath();
            ctx.arc(250, 250, usableRadius*scale, 0, 7);
            ctx.fillStyle = '#e2e8f0'; ctx.fill();
            ctx.strokeStyle = '#1e293b'; ctx.lineWidth = 2; ctx.stroke();

            cables.forEach(c => {
                ctx.beginPath();
                ctx.arc(250 + c.x*scale, 250 + c.y*scale, c.r*scale, 0, 7);
                ctx.fillStyle = colors[c.type]; ctx.fill();
                ctx.strokeStyle = 'rgba(255,255,255,0.6)'; ctx.lineWidth = 1; ctx.stroke();
            });
        }

        function updateConduitSize() { 
            conduitD = parseFloat(document.getElementById('conSize').value) || 63; 
            usableRadius = (conduitD - (wallThickness * 2)) / 2;
            repack(); 
            update(); 
        }
        function reset() { cables = []; update(); }
        update();
    </script>
</body>
</html>