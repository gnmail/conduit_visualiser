<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AS/NZS 3000 Conduit Visualiser</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary: #2563eb; --danger: #dc2626; --success: #16a34a;
            --bg: #f1f5f9; --card-bg: #ffffff; --text: #1e293b; --border: #cbd5e1;
        }
        body { font-family: system-ui, -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; max-width: 1300px; width: 100%; }
        .controls { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); flex: 1; min-width: 380px; max-width: 500px; }
        .category-group { background: #f8fafc; padding: 12px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 15px; }
        h3 { margin-top: 0; font-size: 1rem; color: var(--primary); border-bottom: 1px solid var(--border); padding-bottom: 5px; }
        label { display: block; margin: 10px 0 5px; font-weight: 700; font-size: 0.8rem; }
        select, input { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; box-sizing: border-box; }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
        .btn { padding: 10px; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; font-size: 0.8rem; transition: 0.2s; }
        .btn-add { background: var(--primary); color: white; }
        .btn-fill { background: #0f172a; color: white; }
        .btn-pdf { background: #059669; color: white; width: 100%; margin-top: 10px; font-size: 1rem; }
        .btn-reset { background: #64748b; color: white; width: 100%; margin-top: 15px; }
        .stats-panel { border-top: 2px solid var(--border); margin-top: 20px; padding-top: 15px; }
        .stat-row { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; }
        .fill-bar-bg { height: 24px; background: #e2e8f0; border-radius: 12px; overflow: hidden; position: relative; margin: 10px 0; border: 1px solid #94a3b8; }
        .fill-bar-inner { height: 100%; width: 0%; transition: 0.4s ease-out; }
        .limit-line { position: absolute; top: 0; bottom: 0; width: 3px; background: #000; z-index: 5; }
        .inventory { margin-top: 15px; max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 6px; background: white; }
        .inv-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; border-bottom: 1px solid #f1f5f9; font-size: 0.75rem; }
        .btn-remove { background: #fee2e2; color: var(--danger); border: 1px solid #fecaca; padding: 2px 6px; border-radius: 3px; cursor: pointer; }
        .canvas-area { background: var(--card-bg); padding: 30px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); text-align: center; position: sticky; top: 20px; height: fit-content; }
        .conduit-label { font-size: 1.2rem; font-weight: 800; color: #1e293b; margin-bottom: 5px; padding: 8px; background: #f8fafc; border-radius: 6px; border: 1px dashed var(--border); }
        .dimension-label { font-size: 0.85rem; color: #64748b; margin-bottom: 15px; font-weight: 500; }
        .warning-msg { color: var(--danger); background: #fef2f2; padding: 10px; border-radius: 6px; font-size: 0.85rem; margin-top: 10px; display: none; font-weight: bold; border: 1px solid #fee2e2; }
    </style>
</head>
<body>

    <h1 style="margin-bottom:25px;">AS/NZS 3000 Conduit Visualiser</h1>

    <div class="container">
        <div class="controls">
            <div class="category-group" style="background: #fff;">
                <label>Select Orange HD Conduit Size</label>
                <select id="conSize" onchange="updateConduitSize()">
                    <option value="20" data-type="OD">20mm (OD)</option>
                    <option value="25" data-type="OD">25mm (OD)</option>
                    <option value="32" data-type="OD">32mm (OD)</option>
                    <option value="40" data-type="OD">40mm (OD)</option>
                    <option value="50" data-type="OD">50mm (OD)</option>
                    <option value="63" data-type="OD" selected>63mm (OD)</option>
                    <option value="80" data-type="ID">80mm (ID)</option>
                    <option value="100" data-type="ID">100mm (ID)</option>
                    <option value="125" data-type="ID">125mm (ID)</option>
                    <option value="150" data-type="ID">150mm (ID)</option>
                </select>
            </div>

            <div class="category-group">
                <h3>Power</h3>
                <select id="pwrSel">
                    <optgroup label="TriCab Al XL (Flexible)">
                        <option value="6.8">1.5mm² Al XL (6.8mm OD)</option>
                        <option value="7.6">2.5mm² Al XL (7.6mm OD)</option>
                        <option value="8.9">4.0mm² Al XL (8.9mm OD)</option>
                        <option value="10.2">6.0mm² Al XL (10.2mm OD)</option>
                        <option value="12.1">10mm² Al XL (12.1mm OD)</option>
                        <option value="20.8">16mm² Al XL (20.8mm OD)</option>
                        <option value="23.2">25mm² Al XL (23.2mm OD)</option>
                        <option value="26.1">35mm² Al XL (26.1mm OD)</option>
                        <option value="28.9">50mm² Al XL (28.9mm OD)</option>
                        <option value="33.5">70mm² Al XL (33.5mm OD)</option>
                        <option value="37.8">95mm² Al XL (37.8mm OD)</option>
                    </optgroup>
                    <optgroup label="Flat TPS (2C + E)">
                        <option value="9.9">1.5mm² Flat (9.9mm OD)</option>
                        <option value="11.2">2.5mm² Flat (11.2mm OD)</option>
                        <option value="14.5">6.0mm² Flat (14.5mm OD)</option>
                        <option value="22.3">16mm² Flat (22.3mm OD)</option>
                        <option value="26.8">25mm² Flat (26.8mm OD)</option>
                        <option value="36.0">50mm² Flat (36.0mm OD)</option>
                        <option value="48.5">95mm² Flat (48.5mm OD)</option>
                    </optgroup>
                    <optgroup label="Orange Circular (2C + E)">
                        <option value="10.5">1.5mm² OC (10.5mm OD)</option>
                        <option value="11.6">2.5mm² OC (11.6mm OD)</option>
                        <option value="14.8">6.0mm² OC (14.8mm OD)</option>
                        <option value="21.3">16mm² OC (21.3mm OD)</option>
                        <option value="25.2">25mm² OC (25.2mm OD)</option>
                        <option value="32.5">50mm² OC (32.5mm OD)</option>
                        <option value="42.8">95mm² OC (42.8mm OD)</option>
                    </optgroup>
                </select>
                <div class="btn-grid">
                    <button class="btn btn-add" onclick="handleAdd('pwrSel', 'Power')">Add One</button>
                    <button class="btn btn-fill" onclick="handleBulk('pwrSel', 'Power')">Fill to Max</button>
                </div>
            </div>

            <div class="category-group">
                <h3>Fibre</h3>
                <select id="fbrSel">
                    <optgroup label="MILSPEC">
                        <option value="5.5">2-Core MILSPEC (5.5mm OD)</option>
                        <option value="6.5">4-Core MILSPEC (6.5mm OD)</option>
                    </optgroup>
                    <optgroup label="Loose Tube Fibre">
                        <option value="9.5">12-Core SM (9.5mm OD)</option>
                        <option value="12.5">24-Core SM (12.5mm OD)</option>
                        <option value="15.5">48-Core SM (15.5mm OD)</option>
                        <option value="18.0">72-Core SM (18.0mm OD)</option>
                        <option value="22.5">144-Core SM (22.5mm OD)</option>
                        <option value="24.8">216-Core SM (24.8mm OD)</option>
                    </optgroup>
                </select>
                <div class="btn-grid">
                    <button class="btn btn-add" style="background:#0284c7" onclick="handleAdd('fbrSel', 'Fibre')">Add One</button>
                    <button class="btn btn-fill" onclick="handleBulk('fbrSel', 'Fibre')">Fill to Max</button>
                </div>
            </div>

            <div class="category-group">
                <h3>Traffic Signals</h3>
                <select id="trfSel">
                    <optgroup label="Traffic Signals">
                        <option value="8.1">Loop Feeder (8.1mm OD)</option>
                        <option value="11.5">6-Core Traffic (11.5mm OD)</option>
                        <option value="19.2">19-Core Traffic (19.2mm OD)</option>
                        <option value="24.5">29-Core Traffic (24.5mm OD)</option>
                        <option value="27.8">36-Core Traffic (27.8mm OD)</option>
                        <option value="32.0">51-Core Traffic (32.0mm OD)</option>
                    </optgroup>
                </select>
                <div class="btn-grid">
                    <button class="btn btn-add" style="background:#ea580c" onclick="handleAdd('trfSel', 'Traffic Signals')">Add One</button>
                    <button class="btn btn-fill" onclick="handleBulk('trfSel', 'Traffic Signals')">Fill to Max</button>
                </div>
            </div>

            <div class="stats-panel">
                <div class="stat-row">
                    <span>Fill: <span id="fillPct">0%</span></span>
                    <span>Allowed (AS3000): <span id="allowedPct">50%</span></span>
                </div>
                <div class="fill-bar-bg">
                    <div id="barLimit" class="limit-line" style="left: 50%;"></div>
                    <div id="barInner" class="fill-bar-inner"></div>
                </div>
                <div id="warn" class="warning-msg"></div>
                <div class="inventory" id="invList"></div>
                <button class="btn btn-reset" onclick="reset()">Reset All Data</button>
            </div>
        </div>

        <div class="canvas-area">
            <div class="conduit-label" id="currentConduitDisplay">63mm Conduit</div>
            <div class="dimension-label" id="dimDisplay">Outer: 63mm | Inner: 56.6mm</div>
            
            <canvas id="c" width="500" height="500"></canvas>
            
            <div style="margin: 20px 0; text-align: left; background: #f8fafc; padding: 15px; border-radius: 8px; border: 1px solid var(--border);">
                <label style="margin-top: 0;">Project Name</label>
                <input type="text" id="projName" placeholder="Enter project identifier...">
                <button class="btn btn-pdf" onclick="exportToPDF()">Export to PDF</button>
            </div>
        </div>
    </div>

    <script>
        let currentOD = 63, internalRadius = (63 - 6.4) / 2;
        let cables = [];
        const canvas = document.getElementById('c'), ctx = canvas.getContext('2d');
        const colors = { 'Power': '#ef4444', 'Fibre': '#0284c7', 'Traffic Signals': '#ea580c' };

        function handleAdd(id, type) {
            const sel = document.getElementById(id);
            const opt = sel.options[sel.selectedIndex];
            const group = opt.parentElement.label;
            const d = parseFloat(sel.value), label = opt.text;
            if (addCableLogic(d, type, label, group)) update();
        }

        function handleBulk(id, type) {
            const sel = document.getElementById(id);
            const opt = sel.options[sel.selectedIndex];
            const group = opt.parentElement.label;
            const d = parseFloat(sel.value), label = opt.text;
            while (true) {
                const tempArea = cables.reduce((acc, c) => acc + Math.PI * c.r**2, 0) + (Math.PI * (d/2)**2);
                const limit = (cables.length + 1) >= 2 ? (cables.length + 1 === 2 ? 33 : 40) : 50;
                if ((tempArea / (Math.PI * internalRadius**2)) * 100 > limit) break;
                if (!addCableLogic(d, type, label, group)) break;
            }
            update();
        }

        function addCableLogic(d, type, label, group) {
            const r = d / 2;
            const pos = findPos(r);
            if (pos) {
                cables.push({ id: Math.random(), x: pos.x, y: pos.y, r, d, type, label, group });
                return true;
            }
            document.getElementById('warn').style.display = 'block';
            document.getElementById('warn').textContent = "Physical Capacity Exhausted.";
            return false;
        }

        function findPos(r) {
            for (let y = internalRadius - r; y > -internalRadius + r; y -= 0.5) {
                for (let x = -internalRadius + r; x < internalRadius - r; x += 0.5) {
                    if (Math.sqrt(x*x + y*y) + r <= internalRadius && !cables.some(c => Math.sqrt((x-c.x)**2 + (y-c.y)**2) < (r + c.r) - 0.05)) return {x, y};
                }
            }
            return null;
        }

        function update() {
            const area = cables.reduce((acc, c) => acc + Math.PI * c.r**2, 0);
            const pct = (area / (Math.PI * internalRadius**2)) * 100;
            const limit = cables.length <= 1 ? 50 : (cables.length === 2 ? 33 : 40);
            
            document.getElementById('currentConduitDisplay').textContent = currentOD.toFixed(0) + 'mm Conduit';
            document.getElementById('dimDisplay').textContent = `Outer: ${currentOD.toFixed(1)}mm | Inner: ${(internalRadius * 2).toFixed(1)}mm`;
            document.getElementById('fillPct').textContent = pct.toFixed(1) + '%';
            document.getElementById('allowedPct').textContent = limit + '%';
            document.getElementById('barLimit').style.left = limit + '%';
            document.getElementById('barInner').style.width = Math.min(pct, 100) + '%';
            document.getElementById('barInner').style.background = pct > limit ? 'var(--danger)' : 'var(--success)';
            
            document.getElementById('invList').innerHTML = cables.map(c => `
                <div class="inv-item"><span>${c.label}</span><button class="btn-remove" onclick="removeCable(${c.id})">✕</button></div>
            `).reverse().join('');
            draw();
        }

        function removeCable(id) { 
            cables = cables.filter(c => c.id !== id); 
            const old = [...cables]; cables = []; 
            old.sort((a,b) => b.r - a.r).forEach(c => { const p = findPos(c.r); if(p) { c.x = p.x; c.y = p.y; cables.push(c); }});
            update(); 
        }

        function draw() {
            ctx.clearRect(0,0,500,500);
            const scale = 440 / currentOD;
            ctx.beginPath(); ctx.arc(250, 250, (currentOD/2)*scale, 0, 7);
            ctx.fillStyle = '#94a3b8'; ctx.fill(); 
            ctx.beginPath(); ctx.arc(250, 250, internalRadius*scale, 0, 7);
            ctx.fillStyle = '#e2e8f0'; ctx.fill();
            ctx.strokeStyle = '#1e293b'; ctx.lineWidth = 2; ctx.stroke();
            cables.forEach(c => {
                ctx.beginPath(); ctx.arc(250 + c.x*scale, 250 + c.y*scale, c.r*scale, 0, 7);
                ctx.fillStyle = colors[c.type]; ctx.fill();
                ctx.strokeStyle = 'rgba(255,255,255,0.6)'; ctx.stroke();
            });
        }

        function updateConduitSize() {
            const sel = document.getElementById('conSize');
            const val = parseFloat(sel.value);
            if (sel.options[sel.selectedIndex].dataset.type === 'ID') {
                internalRadius = val / 2; currentOD = val + 6.4;
            } else {
                currentOD = val; internalRadius = (val - 6.4) / 2;
            }
            cables = []; update();
        }

        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const proj = document.getElementById('projName').value || "Unnamed Project";
            const area = cables.reduce((acc, c) => acc + Math.PI * c.r**2, 0);
            const pct = (area / (Math.PI * internalRadius**2)) * 100;
            const limit = cables.length <= 1 ? 50 : (cables.length === 2 ? 33 : 40);
            
            doc.setFontSize(22); doc.text("Conduit Fill Report", 20, 20);
            doc.setFontSize(11); doc.text(`Project: ${proj}`, 20, 30);
            doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 36);
            doc.text(`Conduit: ${currentOD}mm (Internal: ${internalRadius*2}mm)`, 20, 42);
            
            // Compliance Info
            doc.setFont(undefined, 'bold');
            doc.text(`Fill Level: ${pct.toFixed(1)}%`, 20, 50);
            doc.text(`AS/NZS 3000 Limit: ${limit}%`, 20, 56);
            doc.setTextColor(pct > limit ? 220 : 0, pct > limit ? 38 : 120, 38);
            doc.text(pct > limit ? "STATUS: OVER CAPACITY" : "STATUS: COMPLIANT", 20, 62);
            doc.setTextColor(0, 0, 0); doc.setFont(undefined, 'normal');

            const imgData = canvas.toDataURL('image/png');
            doc.addImage(imgData, 'PNG', 55, 65, 95, 95);

            let tableData = [];
            const uniqueGroups = [...new Set(cables.map(c => c.group))];
            uniqueGroups.forEach(groupName => {
                const groupCables = cables.filter(c => c.group === groupName);
                tableData.push([{ content: groupName.toUpperCase(), styles: { fillColor: [240, 240, 240], fontStyle: 'bold' } }]);
                const counts = {};
                groupCables.forEach(c => { counts[c.label] = (counts[c.label] || 0) + 1; });
                Object.keys(counts).forEach(label => tableData.push([`${counts[label]} x ${label}`]));
            });

            doc.autoTable({
                startY: 165,
                head: [['Cable Schedule']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [37, 99, 235] }
            });

            doc.save(`${proj.replace(/\s+/g, '_')}_Report.pdf`);
        }

        function reset() { cables = []; update(); }
        update();
    </script>
</body>
</html>
